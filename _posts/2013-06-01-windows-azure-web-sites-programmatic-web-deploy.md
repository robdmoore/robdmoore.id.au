---
layout: post
title: Windows Azure Web Sites Programmatic Web Deploy
date: 2013-06-01 09:57:09.000000000 +08:00
type: post
categories:
- Technical
tags:
- MSBuild
- MSDeploy
- TeamCity
- Windows Azure
author: rob
---


I was setting up a continuous integration / deployment pipeline last night for my team at [GovHack Perth](http://www.govhack.org/locations/perth/) and I had a lot of trouble getting the web deploy deployment working against an Azure Web Sites site.



I had downloaded the .publishsettings file and copied out the username, password and server to pass through to the .cmd file that is generated by MSBuild when creating a web deploy package. I do this because I [create the package separately as part of the CI build and attach it as a build artifact and then separately do the deployment with msdeploy as another CI build step](http://robdmoore.id.au/blog/2012/09/01/maintainable-teamcity-continuous-deployment-pipeline-configuration/ "Maintainable TeamCity continuous deployment pipeline configuration").



The problem I came across was that I kept getting the following error when running the deployment:


```
C:\Path\To\Project\obj\Release\Package&gt;projectname.deploy.cmd /T /M:https://waws-prod-hk1-001.pu
blish.azurewebsites.windows.net:443/msdeploy.axd /U:$sitename /P:password /A:Basic
SetParameters from:
"C:\Path\To\Project\obj\Release\Package\projectname.SetParameters.xml"
You can change IIS Application Name, Physical path, connectionString
or other deploy parameters in the above file.
-------------------------------------------------------
Start executing msdeploy.exe
-------------------------------------------------------
"C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" -source:package='C:
\Path\To\Project\obj\Release\Package\projectname.zip' -dest:auto,computerName="https://waws-prod
-hk1-001.publish.azurewebsites.windows.net:443/msdeploy.axd",userName="$sitename"
,password="password",authtyp
e="Basic",includeAcls="False" -verb:sync -disableLink:AppPoolExtension -disableL
ink:ContentExtension -disableLink:CertificateExtension -setParamFile:"C:\Path\To\Project\obj
\Release\Package\projectname.SetParameters.xml" -whatif
Info: Using ID '744a18b1-51c2-4d05-a674-6c407a7f80c5' for connections to the rem
ote server.
Error Code: ERROR_USER_UNAUTHORIZED
More Information: Connected to the remote computer ("waws-prod-hk1-001.publish.a
zurewebsites.windows.net") using the Web Management Service, but could not autho
rize. Make sure that you are using the correct user name and password, that the
site you are connecting to exists, and that the credentials represent a user who
has permissions to access the site. Learn more at: http://go.microsoft.com/fwl
ink/?LinkId=221672#ERROR_USER_UNAUTHORIZED.
Error: The remote server returned an error: (401) Unauthorized.
Error count: 1.
```



It turns out the problem was I needed to include the ***?site=sitename***parameter in the msdeploy destination otherwise (I assume) the load balancer on the publish server can't authenticate your username and password properly. This meant I needed to switch to using msdeploy.exe directly like so:



`"C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" -source:package='projectname.zip' -dest:auto,computerName="https://waws-prod-hk1-001.publish.azurewebsites.windows.net:443/msdeploy.axd?site=sitename",userName="$sitename",password="password",authtype="Basic",includeAcls="False" -verb:sync -disableLink:AppPoolExtension -disableLink:ContentExtension -disableLink:CertificateExtension -setParamFile:"projectname.SetParameters.xml"`



Hopefully this post helps other people stuck in the same situation (I couldn't find anything on Google to help with this)!

