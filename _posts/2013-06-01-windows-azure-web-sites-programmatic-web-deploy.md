---
id: 1121
title: Windows Azure Web Sites Programmatic Web Deploy
date: 2013-06-01T09:57:09+00:00
author: rob
layout: post
guid: http://robdmoore.id.au/?p=1121
permalink: /blog/2013/06/01/windows-azure-web-sites-programmatic-web-deploy/
categories:
  - Technical
tags:
  - MSBuild
  - MSDeploy
  - TeamCity
  - Windows Azure
---
I was setting up a continuous integration / deployment pipeline last night for my team at <a href="http://www.govhack.org/locations/perth/" target="_blank">GovHack Perth</a>Â and I had a lot of trouble getting the web deploy deployment working against an Azure Web Sites site.

I had downloaded the .publishsettings file and copied out the username, password and server to pass through to the .cmd file that is generated by MSBuild when creating a web deploy package. I do this because I <a title="Maintainable TeamCity continuous deployment pipeline configuration" href="http://robdmoore.id.au/blog/2012/09/01/maintainable-teamcity-continuous-deployment-pipeline-configuration/" target="_blank">create the package separately as part of the CI build and attach it as a build artifact and then separately do the deployment with msdeploy as another CI build step</a>.

The problem I came across was that I kept getting the following error when running the deployment:

<p style="padding-left: 30px;">
  <code>C:\&lt;em>&lt;strong>Path\To\Project&lt;/strong>&lt;/em>\obj\Release\Package&gt;&lt;em>&lt;strong>projectname&lt;/strong>&lt;/em>.deploy.cmd /T /M:https://waws-prod-hk1-001.pu&lt;br />
blish.azurewebsites.windows.net:443/msdeploy.axd /U:$&lt;em>&lt;strong>sitename&lt;/strong>&lt;/em> /P:&lt;em>&lt;strong>password&lt;/strong>&lt;/em>Â /A:Basic&lt;br />
SetParameters from:&lt;br />
"C:\&lt;em>&lt;strong>Path\To\Project&lt;/strong>&lt;/em>\obj\Release\Package\&lt;em>&lt;strong>projectname&lt;/strong>&lt;/em>.SetParameters.xml"&lt;br />
You can change IIS Application Name, Physical path, connectionString&lt;br />
or other deploy parameters in the above file.&lt;br />
-------------------------------------------------------&lt;br />
Start executing msdeploy.exe&lt;br />
-------------------------------------------------------&lt;br />
"C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" -source:package='C:&lt;br />
\&lt;em>&lt;strong>Path\To\Project&lt;/strong>&lt;/em>\obj\Release\Package\&lt;em>&lt;strong>projectname&lt;/strong>&lt;/em>.zip' -dest:auto,computerName="https://waws-prod&lt;br />
-hk1-001.publish.azurewebsites.windows.net:443/msdeploy.axd",userName="$&lt;em>&lt;strong>sitename&lt;/strong>&lt;/em>"&lt;br />
,password="&lt;em>&lt;strong>password&lt;/strong>&lt;/em>",authtyp&lt;br />
e="Basic",includeAcls="False" -verb:sync -disableLink:AppPoolExtension -disableL&lt;br />
ink:ContentExtension -disableLink:CertificateExtension -setParamFile:"C:\&lt;em>&lt;strong>Path\To\Project&lt;/strong>&lt;/em>\obj&lt;br />
\Release\Package\&lt;em>&lt;strong>projectname&lt;/strong>&lt;/em>.SetParameters.xml" -whatif&lt;br />
Info: Using ID '744a18b1-51c2-4d05-a674-6c407a7f80c5' for connections to the rem&lt;br />
ote server.&lt;br />
Error Code: ERROR_USER_UNAUTHORIZED&lt;br />
More Information: Connected to the remote computer ("waws-prod-hk1-001.publish.a&lt;br />
zurewebsites.windows.net") using the Web Management Service, but could not autho&lt;br />
rize. Make sure that you are using the correct user name and password, that the&lt;br />
site you are connecting to exists, and that the credentials represent a user who&lt;br />
has permissions to access the site. Learn more at: http://go.microsoft.com/fwl&lt;br />
ink/?LinkId=221672#ERROR_USER_UNAUTHORIZED.&lt;br />
Error: The remote server returned an error: (401) Unauthorized.&lt;br />
Error count: 1.</code>
</p>

It turns out the problem was I needed to include theÂ _**?site=sitenameÂ**_ parameter in the msdeploy destination otherwise (I assume) the load balancer on the publish server can&#8217;t authenticate your username and password properly. This meant I needed to switch to using msdeploy.exe directly like so:

<p style="padding-left: 30px;">
  <code>"C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"Â -source:package='&lt;strong>&lt;em>projectname&lt;/em>&lt;/strong>.zip' -dest:auto,computerName="https://waws-prod-hk1-001.publish.azurewebsites.windows.net:443/msdeploy.axd?site=&lt;em>&lt;strong>sitename&lt;/strong>&lt;/em>",userName="$&lt;em>&lt;strong>sitename&lt;/strong>&lt;/em>",password="&lt;em>&lt;strong>password&lt;/strong>&lt;/em>",authtype="Basic",includeAcls="False" -verb:sync -disableLink:AppPoolExtension -disableLink:ContentExtension -disableLink:CertificateExtension -setParamFile:"&lt;em>&lt;strong>projectname&lt;/strong>&lt;/em>.SetParameters.xml"</code>
</p>

Hopefully this post helps other people stuck in the same situation (I couldn&#8217;t find anything on Google to help with this)!